<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Facturas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8f9fa;
            --sidebar-color: #ffffff;
            --text-color: #212529;
            --text-muted: #6c757d;
            --primary: #007bff;
            --primary-hover: #0056b3;
            --border-color: #dee2e6;
            --radius: 8px;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
        }

        .invoice-paper {
            background-color: var(--sidebar-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            transition: all 0.3s ease-in-out;
        }

        .invoice-paper:hover {
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
            transform: translateY(-5px);
        }
        
        input, select {
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
            transition: all 0.3s ease-in-out;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }

        button {
            border-radius: var(--radius);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto px-4 py-12">
        <div class="max-w-5xl mx-auto">
            <div class="text-center mb-10">
                <h1 class="text-4xl font-bold text-gray-800">Generador de Facturas</h1>
                <p class="text-lg text-gray-600 mt-2">Crea y gestiona tus facturas de forma sencilla.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">Datos del Emisor</h2>
                    <div class="space-y-2 text-gray-700">
                        <p><strong>Nombre:</strong> Francisco Javier Pazó Martínez</p>
                        <p><strong>DNI:</strong> 76779007Q</p>
                        <p><strong>Dirección:</strong> Calle Carcasía 44B 1ºF edf Los Rosales.</p>
                        <p><strong>C.P. y Ciudad:</strong> 15200 Noia</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">Datos del Cliente</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="cliente" placeholder="Nombre del cliente" class="w-full md:col-span-2">
                        <input type="text" id="nifCliente" placeholder="NIF del cliente" class="w-full">
                        <input type="text" id="direccionCliente" placeholder="Dirección del cliente" class="w-full">
                        <input type="date" id="fecha" class="w-full">
                        <input type="text" id="numeroFacturaManual" placeholder="Número de Factura" class="w-full">
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                 <h2 class="text-xl font-semibold mb-4 text-gray-700">Detalles de Pago</h2>
                 <input type="text" id="cuentaBancaria" placeholder="IBAN: ESXX XXXX XXXX XXXX XXXX XXXX" class="w-full md:w-2/3">
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Conceptos de la Factura</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full" id="itemsTable">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Unit.</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IVA (%)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="itemsBody">
                            </tbody>
                    </table>
                </div>
                <button id="addItem" class="mt-4 flex items-center text-blue-600 hover:text-blue-800 font-semibold">
                    <i data-feather="plus-circle" class="w-5 h-5 mr-2"></i>Añadir concepto
                </button>
            </div>

            <div class="mt-8 flex justify-end gap-4">
                <button id="generateInvoice" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg flex items-center">
                    <i data-feather="file-text" class="w-5 h-5 mr-2"></i>Generar Factura
                </button>
                <button id="exportPdf" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg flex items-center hidden">
                    <i data-feather="download" class="w-5 h-5 mr-2"></i>Exportar a PDF
                </button>
            </div>
        </div>

        <div id="invoicePreview" class="invoice-paper p-10 max-w-4xl mx-auto hidden mt-12">
            <div class="flex justify-between items-start mb-10 pb-5 border-b-2 border-gray-100">
                <div class="w-1/2">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Emisor</h3>
                    <p id="previewEmisor" class="text-gray-600"></p>
                    <p id="previewNif" class="text-gray-600"></p>
                    <p id="previewDireccion" class="text-gray-600"></p>
                    <p id="previewCpCiudad" class="text-gray-600"></p>
                </div>
                <div class="w-1/2 text-right">
                    <h2 class="text-2xl font-bold text-gray-800">FACTURA</h2>
                    <p class="text-gray-500 mt-2">Nº: <span id="invoiceNumber" class="text-gray-700"></span></p>
                    <p class="text-gray-500">Fecha: <span id="invoiceDate" class="text-gray-700"></span></p>
                </div>
            </div>
            
            <div class="mb-10">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Cliente</h3>
                <p id="previewCliente" class="text-gray-600"></p>
                <p id="previewNifCliente" class="text-gray-600"></p>
                <p id="previewDireccionCliente" class="text-gray-600"></p>
            </div>

            <div class="mb-10">
                <table class="min-w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Unit.</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">IVA</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                        </tr>
                    </thead>
                    <tbody id="previewItems" class="divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>

            <div class="flex justify-between items-start">
                 <div class="text-sm text-gray-500">
                    <p class="font-semibold mb-1">Forma de pago: Transferencia bancaria</p>
                    <p id="previewCuentaBancaria"></p>
                 </div>

                 <div class="w-1/3">
                    <p class="text-xs text-gray-500 mb-4">Operación con inversión del sujeto pasivo conforme al Art. 84 de la ley de I.V.A. 37/1992</p>
                    <div class="bg-gray-100 p-4 rounded-lg">
                        <div class="flex justify-between mb-2">
                            <span class="text-gray-600">Base Imponible:</span>
                            <span id="baseImponible" class="font-semibold text-gray-800"></span>
                        </div>
                        <div class="flex justify-between mb-2">
                            <span class="text-gray-600">IVA:</span>
                            <span id="ivaTotal" class="font-semibold text-gray-800"></span>
                        </div>
                        <div class="border-t border-gray-300 my-2"></div>
                        <div class="flex justify-between font-bold text-lg">
                            <span class="text-gray-800">TOTAL:</span>
                            <span id="totalFactura" class="text-blue-600"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();

            const createItemRow = () => {
                const tbody = document.getElementById('itemsBody');
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td class="px-6 py-4"><input type="text" class="w-full px-2 py-1 border border-gray-300 rounded-md descripcion"></td>
                    <td class="px-6 py-4"><input type="number" min="1" value="1" class="w-20 px-2 py-1 border border-gray-300 rounded-md cantidad"></td>
                    <td class="px-6 py-4"><input type="number" min="0" step="0.01" class="w-24 px-2 py-1 border border-gray-300 rounded-md precio"></td>
                    <td class="px-6 py-4">
                        <select class="w-20 px-2 py-1 border border-gray-300 rounded-md iva">
                            <option value="21">21%</option>
                            <option value="10">10%</option>
                            <option value="4">4%</option>
                            <option value="0">0%</option>
                        </select>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap total-item font-semibold">0.00 €</td>
                    <td class="px-6 py-4"><button class="text-red-500 hover:text-red-700 remove-item"><i data-feather="trash-2" class="w-5 h-5"></i></button></td>
                `;
                tbody.appendChild(newRow);
                feather.replace();
                addItemEventListeners(newRow);
            };

            const addItemEventListeners = (row) => {
                row.querySelectorAll('.cantidad, .precio, .iva, .descripcion').forEach(input => {
                    input.addEventListener('input', () => calculateRowTotal(row));
                });
                row.querySelector('.remove-item').addEventListener('click', () => {
                    row.remove();
                    calculateTotals();
                });
            };

            const calculateRowTotal = (row) => {
                const cantidad = parseFloat(row.querySelector('.cantidad').value) || 0;
                const precio = parseFloat(row.querySelector('.precio').value) || 0;
                const iva = parseFloat(row.querySelector('.iva').value) || 0;
                const total = (cantidad * precio) * (1 + iva / 100);
                row.querySelector('.total-item').textContent = total.toFixed(2) + ' €';
                calculateTotals();
            };

            const calculateTotals = () => {
                let baseImponible = 0;
                let ivaTotal = 0;
                document.querySelectorAll('#itemsBody tr').forEach(row => {
                    const cantidad = parseFloat(row.querySelector('.cantidad').value) || 0;
                    const precio = parseFloat(row.querySelector('.precio').value) || 0;
                    const iva = parseFloat(row.querySelector('.iva').value) || 0;
                    const subtotal = cantidad * precio;
                    baseImponible += subtotal;
                    ivaTotal += subtotal * (iva / 100);
                });

                if (!document.getElementById('invoicePreview').classList.contains('hidden')) {
                    document.getElementById('baseImponible').textContent = baseImponible.toFixed(2) + ' €';
                    document.getElementById('ivaTotal').textContent = ivaTotal.toFixed(2) + ' €';
                    document.getElementById('totalFactura').textContent = (baseImponible + ivaTotal).toFixed(2) + ' €';
                }
            };
            
            document.getElementById('addItem').addEventListener('click', createItemRow);
            createItemRow();

            document.getElementById('generateInvoice').addEventListener('click', () => {
                const today = new Date();
                
                // Usar el número de factura manual
                const manualInvoiceNumber = document.getElementById('numeroFacturaManual').value;
                document.getElementById('invoiceNumber').textContent = manualInvoiceNumber;
                
                const fechaInput = document.getElementById('fecha').value;
                document.getElementById('invoiceDate').textContent = fechaInput ? new Date(fechaInput).toLocaleDateString('es-ES') : today.toLocaleDateString('es-ES');

                // Emisor (Datos Fijos) y Cliente
                document.getElementById('previewEmisor').textContent = 'Francisco Javier Pazó Martínez';
                document.getElementById('previewNif').textContent = 'DNI: 76779007Q';
                document.getElementById('previewDireccion').textContent = 'Calle Carcasía 44B 1ºF edf Los Rosales.';
                document.getElementById('previewCpCiudad').textContent = '15200 Noia';

                document.getElementById('previewCliente').textContent = document.getElementById('cliente').value;
                document.getElementById('previewNifCliente').textContent = 'NIF/CIF: ' + document.getElementById('nifCliente').value;
                document.getElementById('previewDireccionCliente').textContent = document.getElementById('direccionCliente').value;
                document.getElementById('previewCuentaBancaria').textContent = 'IBAN: ' + (document.getElementById('cuentaBancaria').value || 'ESXX XXXX XXXX XXXX XXXX XXXX');

                // Items de la factura
                const previewItems = document.getElementById('previewItems');
                previewItems.innerHTML = '';
                let baseImponible = 0;
                let ivaTotal = 0;

                document.querySelectorAll('#itemsBody tr').forEach(row => {
                    const descripcion = row.querySelector('.descripcion').value;
                    const cantidad = parseFloat(row.querySelector('.cantidad').value) || 0;
                    const precio = parseFloat(row.querySelector('.precio').value) || 0;
                    const iva = parseFloat(row.querySelector('.iva').value) || 0;
                    const subtotal = cantidad * precio;
                    const total = subtotal * (1 + iva / 100);
                    
                    baseImponible += subtotal;
                    ivaTotal += subtotal * (iva / 100);

                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td class="px-6 py-4 text-sm text-gray-600">${descripcion}</td>
                        <td class="px-6 py-4 text-sm text-gray-600 text-right">${cantidad}</td>
                        <td class="px-6 py-4 text-sm text-gray-600 text-right">${precio.toFixed(2)} €</td>
                        <td class="px-6 py-4 text-sm text-gray-600 text-right">${iva}%</td>
                        <td class="px-6 py-4 text-sm text-gray-600 text-right font-semibold">${total.toFixed(2)} €</td>
                    `;
                    previewItems.appendChild(newRow);
                });

                document.getElementById('baseImponible').textContent = baseImponible.toFixed(2) + ' €';
                document.getElementById('ivaTotal').textContent = ivaTotal.toFixed(2) + ' €';
                document.getElementById('totalFactura').textContent = (baseImponible + ivaTotal).toFixed(2) + ' €';

                document.getElementById('invoicePreview').classList.remove('hidden');
                document.getElementById('exportPdf').classList.remove('hidden');
                document.getElementById('invoicePreview').scrollIntoView({ behavior: 'smooth' });
            });

            document.getElementById('exportPdf').addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const element = document.getElementById('invoicePreview');
                html2canvas(element, { scale: 2 }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const imgWidth = 210;
                    const pageHeight = 297;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft > 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    const invoiceNumber = document.getElementById('invoiceNumber').textContent.replace(/[\\/]/g, '-');
                    pdf.save(`factura-${invoiceNumber}.pdf`);
                });
            });

            document.getElementById('fecha').value = new Date().toISOString().split('T')[0];
        });
    </script>
</body>
</html>
